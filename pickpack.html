<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<title>Nailly – Pick & Pack</title>

<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 0 10px 110px;
        font-size: 18px; /* marire generala */
    }

    h1 {
        color: #d81b60;
        font-size: 32px;
        text-align: center;
        margin-bottom: 25px;
    }

    h3 {
        margin-top: 25px;
        font-size: 22px;
        font-weight: 600;
    }

    /* ====== STATS BAR ====== */
    #statsBar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
    }
    .stats-card {
        flex: 1 1 180px;
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 17px;
        background: #f3f3f3;
        box-sizing: border-box;
    }
    .stats-title {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
    }
    .stats-number {
        font-weight: 700;
        font-size: 24px;
        margin-right: 6px;
    }
    .stats-pending--some {
        background: #e8f7e9;
        color: #1e7e34;
    }
    .stats-pending--none {
        background: #fde8e8;
        color: #b10000;
    }
    .stats-done {
        background: #e8f0ff;
        color: #1a3d8f;
    }

    /* === ELEMENTE STANDARD === */
    input, select {
        padding: 18px;
        font-size: 18px;
        margin: 10px 0;
        width: 100%;
        border-radius: 12px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }

    button {
        padding: 20px;
        font-size: 22px;
        width: 100%;
        border-radius: 14px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: #d81b60;
        color: white;
        transition: 0.2s;
        box-sizing: border-box;
    }

    button:hover {
        background: #b0144f;
    }

    /* SEARCH INPUT */
    #orderSearch {
        margin-top: 5px;
    }

    /* TABEL PRODUSE */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
        table-layout: fixed;
    }

    th, td {
        padding: 14px;
        border: 1px solid #ccc;
        word-wrap: break-word;
        white-space: normal;
        font-size: 18px;
    }

    th {
        background: #fafafa;
        font-weight: 600;
    }

    .ok {
        background: #c8f7c5 !important;
    }

    .next-row {
        box-shadow: inset 3px 0 0 #d81b60;
        background: #fff9fc;
    }

    .errorInput {
        background: #ffcccc !important;
    }

    /* META COMANDĂ: TIMER + PROGRES */
    #orderMeta {
        display: none;
        margin-top: 10px;
        margin-bottom: 15px;
    }
    #orderInfoRow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        color: #444;
        margin-bottom: 8px;
    }
    #timerBox {
        font-weight: 600;
        font-size: 18px;
    }
    #progressOuter {
        width: 100%;
        height: 12px;
        background: #eee;
        border-radius: 12px;
        overflow: hidden;
    }
    #progressInner {
        height: 100%;
        width: 0;
        background: #28a745;
        transition: width 0.2s ease-out;
    }
    #progressText {
        margin-top: 6px;
        font-size: 16px;
        color: #555;
    }

    /* BUTON FINAL FIX JOS */
    #finishBtn {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 22px;
        font-size: 24px;
        text-align: center;
        border-radius: 0;
        color: white;
        background: #888;
        opacity: 0.85;
        pointer-events: none;
        transition: 0.25s;
        display: none;
        z-index: 999;
    }
    #finishBtn.active {
        background: #28a745;
        opacity: 1;
        pointer-events: auto;
    }

    /* CAMERA */
    #cameraScanner {
        width: 100%;
        margin-top: 12px;
        display: none;
    }

    /* ======== OPTIMIZARE PENTRU MOBIL ======== */
    @media (max-width: 600px) {
        h1 {
            font-size: 30px;
        }

        th, td {
            font-size: 18px;
            padding: 14px;
        }

        button {
            padding: 22px;
            font-size: 24px;
        }

        input, select {
            padding: 18px;
            font-size: 18px;
        }
    }
</style>
</head>

<body>

<h1>Nailly – Pick & Pack</h1>

<!-- STATS -->
<div id="statsBar">
    <div id="pendingBox" class="stats-card stats-pending--none">
        <span class="stats-title">Status comenzi</span>
        <span class="stats-number" id="pendingCount">0</span>
        <span>comenzi de pregătit</span>
    </div>
    <div id="doneBox" class="stats-card stats-done">
        <span class="stats-title">Activitatea de astăzi</span>
        <span class="stats-number" id="doneCount">0</span>
        <span>comenzi finalizate</span>
    </div>
</div>

<!-- ================= PAS 1 ================= -->
<h3>Pas 1: Selectează comanda</h3>

<input id="orderSearch" placeholder="Caută comandă după număr..." oninput="filterOrders()" />

<select id="orderList">
    <option>Se încarcă comenzile...</option>
</select>

<button onclick="loadOrder()">Încarcă comanda</button>

<h3 id="orderTitle"></h3>

<div id="orderMeta">
    <div id="orderInfoRow">
        <span id="orderCode"></span>
        <span id="timerBox">Timp: <span id="timer">00:00</span></span>
    </div>
    <div id="progressOuter">
        <div id="progressInner"></div>
    </div>
    <div id="progressText"></div>
</div>

<!-- ================= PAS 2 ================= -->
<h3>Pas 2: Scanează produsele</h3>

<input id="scanInput"
       placeholder="Scanează EAN / SKU..."
       onkeypress="handleScan(event)"
       disabled />

<button onclick="startCameraScan()">Scanează cu camera telefonului</button>

<div id="cameraScanner"></div>

<table id="productsTable">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Produs</th>
            <th>Raft</th>
            <th>Cantitate</th>
            <th>Scanat</th>
            <th>Rămas</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- BUTON FIX JOS -->
<button id="finishBtn" onclick="finalizeOrder()">Finalizează comanda</button>

<!-- LIBRĂRIE CAMERA -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
// ===================== CONFIG ======================
const ORDER_LIST_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/orders-list";

const ORDER_GET_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/order-get";

const DELETE_ORDER_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/delete-order-file-orderId-";

const PRODUCT_LOCATION_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?sku=eq.";

const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bXFmc2lneGVjbXJ5Z21ib2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNDQ0MzgsImV4cCI6MjA3NTYyMDQzOH0.b9MXrgxADVZGvdFaKFQggD-vMd0ayZ9hX4_PmYOzrfE";

let currentProducts = [];
let currentOrderId = null;
let allOrders = [];
let timerInterval = null;
let orderStartTime = null;

// ===================== HELPER: DATE KEY ======================
function getTodayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `nailly_pnp_done_${y}${m}${day}`;
}

// ===================== AUDIO + VIBRAȚIE ======================
function playBeep(freq = 800, duration = 120, type = "sine") {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(
      0.001,
      ctx.currentTime + duration / 1000
    );
    osc.stop(ctx.currentTime + duration / 1000 + 0.02);
  } catch (e) {
    // ignorăm dacă nu e suportat
  }
}

function feedbackSuccess() {
  playBeep(900, 100, "square");
  if (navigator.vibrate) navigator.vibrate(40);
}

function feedbackError() {
  playBeep(220, 200, "sawtooth");
  if (navigator.vibrate) navigator.vibrate([0, 80, 40, 80]);
}

// ===================== TIMER ======================
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  orderStartTime = Date.now();
  const timerEl = document.getElementById("timer");
  timerEl.textContent = "00:00";

  timerInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - orderStartTime) / 1000);
    const m = String(Math.floor(diff / 60)).padStart(2, "0");
    const s = String(diff % 60).padStart(2, "0");
    timerEl.textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

// ===================== STATS UI ======================
function updateStats() {
  const pendingBox = document.getElementById("pendingBox");
  const pendingCountEl = document.getElementById("pendingCount");
  const doneCountEl = document.getElementById("doneCount");
  const select = document.getElementById("orderList");

  // comenzi în listă (excluzând cazul "Nu există comenzi...")
  let pending = 0;
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value) pending++;
  }

  pendingCountEl.textContent = pending;
  pendingBox.classList.remove("stats-pending--some", "stats-pending--none");
  if (pending > 0) {
    pendingBox.classList.add("stats-pending--some");
  } else {
    pendingBox.classList.add("stats-pending--none");
  }

  const key = getTodayKey();
  const done = Number(localStorage.getItem(key) || "0");
  doneCountEl.textContent = done;
}

// ===================== REBUILD ORDER LIST ======================
function rebuildOrderList() {
  const select = document.getElementById("orderList");
  const searchInput = document.getElementById("orderSearch");
  const term = (searchInput.value || "").trim();

  select.innerHTML = "";

  let filtered = allOrders;
  if (term) {
    filtered = allOrders.filter(o =>
      String(o.orderId).includes(term)
    );
  }

  if (filtered.length === 0) {
    const opt = document.createElement("option");
    opt.textContent = "Nu există comenzi de pregătit";
    opt.value = "";
    select.appendChild(opt);
  } else {
    filtered.forEach((o, index) => {
      const opt = document.createElement("option");
      opt.value = o.orderId;
      opt.textContent = `${index + 1}. Comanda #${o.orderId}`;
      select.appendChild(opt);
    });
  }

  updateStats();
}

function filterOrders() {
  rebuildOrderList();
}

// ===================== LOAD ORDERS ======================
async function loadOrders() {
  try {
    const res = await fetch(ORDER_LIST_URL);
    const orders = await res.json();

    allOrders = Array.isArray(orders) ? orders : [];
    rebuildOrderList();

    // dacă nu există comenzi → resetăm UI
    if (!allOrders.length) {
      currentOrderId = null;
      currentProducts = [];
      document.getElementById("orderTitle").textContent = "";
      document.getElementById("orderMeta").style.display = "none";
      document.querySelector("#productsTable tbody").innerHTML = "";
      const scanInput = document.getElementById("scanInput");
      scanInput.value = "";
      scanInput.disabled = true;
      const btn = document.getElementById("finishBtn");
      btn.style.display = "none";
      btn.classList.remove("active");
    }

  } catch (err) {
    alert("Eroare la încărcarea comenzilor!");
    console.error(err);
  }
}

// ===================== LOAD ORDER ======================
async function loadOrder() {
  const select = document.getElementById("orderList");
  const orderId = select.value;
  if (!orderId) return;

  currentOrderId = orderId;

  const res = await fetch(`${ORDER_GET_URL}?orderId=${orderId}`);
  const data = await res.json();

  currentProducts = await Promise.all(
    data.line_items
      .filter(p => p.item_type === "product")
      .map(async p => {
        let originalSku = p.product_sku || "";
        let lookupSku = originalSku.replace(/^0+/, "");

        let locRes = await fetch(PRODUCT_LOCATION_URL + encodeURIComponent(lookupSku), {
          method: "GET",
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          }
        });

        let locData = [];
        try {
          locData = await locRes.json();
        } catch (_) {}

        let shelf =
          locData.length > 0 &&
          locData[0].location &&
          locData[0].location !== "EMPTY"
            ? locData[0].location
            : "Fără locație";

        return {
          sku: originalSku,
          ean: p.product_ean,
          name: p.product_name,
          qty: Number(p.quantity),
          shelf,
          scanned: 0
        };
      })
  );

  // sortare după raft (o singură trecere optimă)
  currentProducts.sort((a, b) => {
    if (a.shelf === b.shelf) {
      return String(a.sku).localeCompare(String(b.sku));
    }
    return String(a.shelf).localeCompare(String(b.shelf));
  });

  document.getElementById("orderTitle").textContent = "Comanda #" + orderId;
  document.getElementById("orderCode").textContent = "ID comandă: " + orderId;
  document.getElementById("orderMeta").style.display = "block";

  const scanInput = document.getElementById("scanInput");
  scanInput.disabled = false;
  scanInput.focus();

  const btn = document.getElementById("finishBtn");
  btn.style.display = "block";
  btn.classList.remove("active");

  startTimer();
  renderTable();
}

// ===================== TABLE ======================
function renderTable() {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";

  const nextIndex = currentProducts.findIndex(p => p.scanned < p.qty);

  currentProducts.forEach((p, index) => {
    const tr = document.createElement("tr");
    if (index === nextIndex) tr.classList.add("next-row");
    if (p.scanned === p.qty) tr.classList.add("ok");

    tr.innerHTML = `
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${p.shelf}</td>
        <td>${p.qty}</td>
        <td>${p.scanned}</td>
        <td>${p.qty - p.scanned}</td>
    `;
    tbody.appendChild(tr);
  });

  // progres total
  const totalQty = currentProducts.reduce((s, p) => s + p.qty, 0);
  const totalScanned = currentProducts.reduce((s, p) => s + p.scanned, 0);
  const pct = totalQty > 0 ? Math.round((totalScanned / totalQty) * 100) : 0;

  const progressInner = document.getElementById("progressInner");
  const progressText = document.getElementById("progressText");
  progressInner.style.width = pct + "%";
  progressText.textContent = `Progres: ${totalScanned}/${totalQty} (${pct}%)`;

  updateFinishButtonState();
}

// ===================== CHECK IF ALL PRODUCTS ARE SCANNED ======================
function updateFinishButtonState() {
  const allScanned = currentProducts.length > 0 &&
    currentProducts.every(p => p.scanned >= p.qty);

  const btn = document.getElementById("finishBtn");
  if (allScanned) {
    btn.classList.add("active");
  } else {
    btn.classList.remove("active");
  }
}

// ===================== SCAN ======================
function handleScan(event) {
  if (event.key !== "Enter") return;

  const code = event.target.value.trim();
  event.target.value = "";

  let found = currentProducts.find(
    p => p.sku === code || p.ean === code
  );

  if (!found) {
    feedbackError();
    flashError();
    return;
  }

  if (found.scanned < found.qty) {
    found.scanned++;
    feedbackSuccess();
    renderTable();
  } else {
    feedbackError();
    flashError();
  }
}

function flashError() {
  let input = document.getElementById("scanInput");
  input.classList.add("errorInput");
  setTimeout(() => input.classList.remove("errorInput"), 300);
}

// ===================== CAMERA SCAN ======================
function startCameraScan() {
  const div = document.getElementById("cameraScanner");
  div.style.display = "block";

  const html5QrCode = new Html5Qrcode("cameraScanner");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 150 } },
    (decodedText) => {
      document.getElementById("scanInput").value = decodedText;
      handleScan({ key: "Enter", target: { value: decodedText } });

      html5QrCode.stop().then(() => {
        div.style.display = "none";
      });
    }
  );
}

// ===================== FINALIZE ORDER ======================
async function finalizeOrder() {
  const btn = document.getElementById("finishBtn");

  if (!btn.classList.contains("active")) {
    alert("Trebuie să scanezi toate produsele!");
    return;
  }

  if (!currentOrderId) {
    alert("Nu există comandă încărcată!");
    return;
  }

  if (!confirm("Finalizezi comanda?")) return;

  try {
    const res = await fetch(DELETE_ORDER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId: currentOrderId }),
    });

    const result = await res.json().catch(() => ({}));

    if (res.ok && result.deleted?.length > 0) {
      alert("Comanda a fost finalizată!");

      // incrementăm contorul din ziua curentă
      const key = getTodayKey();
      const prev = Number(localStorage.getItem(key) || "0");
      localStorage.setItem(key, String(prev + 1));

      // reset UI pentru comandă
      stopTimer();
      currentProducts = [];
      currentOrderId = null;
      document.getElementById("orderTitle").textContent = "";
      document.getElementById("orderMeta").style.display = "none";
      document.querySelector("#productsTable tbody").innerHTML = "";

      const scanInput = document.getElementById("scanInput");
      scanInput.value = "";
      scanInput.disabled = true;

      btn.style.display = "none";
      btn.classList.remove("active");

      await loadOrders(); // reîncarcă lista și updatează stats

    } else {
      alert("Eroare la ștergerea fișierului!");
      console.error(result);
    }

  } catch (err) {
    console.error(err);
    alert("Eroare la server!");
  }
}

// ===================== INIT ======================
loadOrders();
</script>
</body>
</html>
