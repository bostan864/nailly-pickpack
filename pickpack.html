<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<title>Nailly ‚Äì Pick & Pack PRO</title>
<style>
  :root{
    --brand:#d81b60;
    --ok:#28a745;
    --blue:#2f80ed;
    --text:#222;
    --muted:#666;
    --bg:#f5f5f7;

    /* control central pentru bottom nav */
    --bottomNavH: 140px;      /* √ÆnƒÉl»õime barƒÉ */
    --finishGap: 9px;        /* dacƒÉ vrei spa»õiu extra √Æntre finish »ôi nav */
}
#productsTable {
  margin-bottom: calc(var(--bottomNavH) + 100px);
}

  *{ box-sizing:border-box; }

  body{
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 12px 10px calc(var(--bottomNavH) + 38px); /* spa»õiu bottom nav + rezervƒÉ */
    font-size: 18px;
    color: var(--text);
    background: var(--bg);
  }
  /* APP HEADER */
  .app-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 6px 8px;
}


  .logo-header{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo-header img{
    max-width: 120px;
    width: 42%;
    height:auto;
    border-radius: 18px;
  }

  .app-header-title{
    text-align:right;
    font-size:14px;
    color:var(--muted);
  }
  .app-header-title strong{
    display:block;
    font-size:16px;
    color:#000;
  }

  h3{
    margin-top: 18px;
    font-size: 20px;
    font-weight: 700;
  }

  /* STATS */
  #statsBar{
    display:flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 6px 0 10px;
  }
  .stats-card{
    flex: 1 1 180px;
    padding: 10px 12px;
    border-radius: 14px;
    background:#ffffff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
  }
  .stats-title{
    display:block;
    margin-bottom: 4px;
    font-weight: 700;
    font-size: 14px;
    color: #444;
  }
  .stats-number{
    font-weight: 800;
    font-size: 26px;
    margin-right: 4px;
  }
  .stats-pending--some{ background:#e8f7e9; color:#1e7e34; }
  .stats-pending--none{ background:#fde8e8; color:#b10000; }
  .stats-done{ background:#e8f0ff; color:#1a3d8f; }

  /* ORDER TITLE + META */
  #orderTitle{
    margin-top:14px;
    font-size: 22px;
    font-weight: 800;
  }

  #orderMeta{
    display:none;
    margin: 8px 0 12px;
    padding: 8px 10px 10px;
    background:#ffffff;
    border-radius: 14px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
  }
  #orderInfoRow{
    display:flex;
    justify-content: space-between;
    align-items:center;
    font-size: 15px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  #orderCode{
    font-weight:600;
    color:#333;
  }
  #timerBox{
    font-weight: 800;
    font-size: 16px;
    color:#333;
  }

  #progressOuter{
    width:100%;
    height: 14px;
    background:#eee;
    border-radius: 999px;
    overflow:hidden;
  }
  #progressInner{
    height:100%;
    width:0;
    background: var(--ok);
    transition: width .2s ease-out;
  }
  #progressText{
    margin-top: 6px;
    font-size: 15px;
    color:#555;
  }

  /* INPUTS */
  input{
    padding: 16px;
    font-size: 18px;
    margin: 8px 0 6px;
    width: 100%;
    border-radius: 14px;
    border: 1px solid #ccc;
    background:#fff;
  }
  input:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 2px rgba(216,27,96,0.18);
  }

  /* BUTTONS (globale) */
  button{
    padding: 18px;
    font-size: 18px;
    width: 100%;
    border-radius: 14px;
    font-weight: 700;
    cursor:pointer;
    border:none;
    background: var(--brand);
    color:#fff;
    transition: .15s;
  }
  button:hover{ filter: brightness(.96); }

  /* CAMERA BUTTON */
  #cameraBtn{
    margin-top: 6px;
    background:#ffffff;
    color:#333;
    border:1px solid #ddd;
  }

  /* CAMERA PREVIEW */
  #cameraScanner{
    width:100%;
    margin-top: 12px;
    display:none;
    border-radius:14px;
    overflow:hidden;
    background:#000;
  }

  /* TABLE */
  table{
    width:100%;
    border-collapse: collapse;
    margin-top: 12px;
    table-layout: fixed;
    background:#ffffff;
    border-radius: 14px;
    overflow:hidden;
  }
  th, td{
    padding: 12px 8px;
    border: 1px solid #eee;
    word-wrap: break-word;
    white-space: normal;
    font-size: 16px;
  }
  th{
    background:#fafafa;
    font-weight: 800;
  }

  .ok{ background:#c8f7c5 !important; }
  .next-row{
    background:#ffe4ef !important;
    border-left: 6px solid var(--brand) !important;
  }
  .errorInput{ background:#ffcccc !important; }

  /* RAFT = foarte vizibil */
  #productsTable td:nth-child(3){
    font-weight: 900;
    font-size: 18px;
    color:var(--brand);
  }

  /* CENTRARE cantitƒÉ»õi */
  #productsTable td:nth-child(4),
  #productsTable td:nth-child(5),
  #productsTable td:nth-child(6){
    text-align:center;
  }

  /* FINISH BTN (deasupra bottom nav) */
  #finishBtn{
    position: fixed;
    left:0;
    bottom: calc(var(--bottomNavH) + var(--finishGap));
    width:100%;
    padding: 20px;
    font-size: 20px;
    text-align:center;
    border-radius: 0;
    background:#9e9e9e;
    opacity:.85;
    pointer-events:none;
    display:none;
    z-index: 5000;
  }
  #finishBtn.active{
    background: var(--ok);
    opacity:1;
    pointer-events:auto;
  }

  /* ORDERS PANEL */
  .orders-panel{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70vh;
    background: #fff;
    box-shadow: 0 -12px 30px rgba(0,0,0,0.25);
    border-top-left-radius: 18px;
    border-top-right-radius: 18px;
    transform: translateY(100%);
    transition: transform .22s ease;
    z-index: 6500;
    display:flex;
    flex-direction: column;
  }
  .orders-panel.open{ transform: translateY(0); }

  .orders-panel-header{
    display:flex;
    justify-content: space-between;
    align-items:center;
    padding: 14px 16px;
    border-bottom: 1px solid #eee;
    font-size: 18px;
    font-weight: 800;
  }
  .orders-panel-header .close-btn{
    width: 36px;
    height: 36px;
    border-radius: 999px;
    background: #f2f2f2;
    border: 1px solid #e6e6e6;
    color: #111;
    font-weight: 900;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .orders-panel-list{
    flex:1;
    overflow-y:auto;
  }
  .order-row {
  padding: 22px 20px; /* üî• mai mult spa»õiu vertical + lateral */
  border-bottom: 1px solid #f0f0f0;
  font-size: 22px;    /* üî• text mai mare, mai u»ôor de citit */
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

  .order-row span{
    font-size:14px;
    color:var(--muted);
  }
  .order-row:hover{ background:#f7f7f7; }

  /* QUICK SEARCH OVERLAY */
  #quickSearchOverlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.78);
    display:none;
    z-index: 7000;
  }
  #quickSearchOverlay.active{ display:block; }

  .quickSearchBox{
    position: fixed;
    top: 88px;
    left: 50%;
    transform: translateX(-50%);
    width: min(520px, 92vw);
  }

  .quickSearchInputWrap{
    position: relative;
    width: 100%;
  }

  #quickSearchInput{
  width: 100%;
  height: 74px; /* üî• mai √ÆnaltƒÉ */
  padding: 0 66px 0 22px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.35);
  background: rgba(0,0,0,0.35);
  color:#fff;
  font-size: 24px; /* üî• text mai mare, mai u»ôor de tastat */
  outline:none;
}

  #quickSearchInput::placeholder{ color: rgba(255,255,255,0.75); }

  #quickSearchBtn{
    position:absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 999px;
    background:#fff;
    color:#111;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    cursor:pointer;
    font-weight: 900;
  }

  #quickSearchClose{
    position:absolute;
    right: -52px;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: rgba(255,255,255,0.16);
    border: 1px solid rgba(255,255,255,0.28);
    color:#fff;
    font-size: 22px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
  }

  #quickSearchResults {
  position: absolute;
  top: 62px;
  left: 0;
  width: 100%;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 14px 35px rgba(0, 0, 0, 0.35);
  max-height: 420px; /* doar asta, fƒÉrƒÉ 60vh */
  overflow-y: auto;
  display: none;
}

  #quickSearchResults.show{ display:block; }

  .quick-search-item {
  padding: 23px 23px; /* üî• mƒÉrim padding vertical */
  font-size: 26px;     /* üî• text mai mare */
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

  .quick-search-item:last-child{ border-bottom:none; }
  .quick-search-item:hover{ background:#f5f7fb; }

  /********************************************
   * BOTTOM NAV ‚Äì FIX REAL (nu mai e afectat de button global)
   ********************************************/
  #bottomNav{
    position: fixed;
    bottom:0;
    left:0;
    width:100%;
    height: var(--bottomNavH);
    background:#ffffff;
    border-top: 1px solid #ddd;
    display:flex;
    z-index: 7200;
    box-shadow: 0 -4px 14px rgba(0,0,0,0.12);
  }

  /* reset complet pentru button-urile din bottom nav */
  #bottomNav .nav-btn{
    flex:1;
    height:100%;

    /* IMPORTANT: anulƒÉm stilul global de button */
    width:auto !important;
    padding: 10px 6px !important;
    border-radius: 0 !important;
    background: none !important;
    color:#111 !important;

    border:none !important;
    cursor:pointer;

    display:flex;
    flex-direction: column;
    align-items:center;
    justify-content:center;
    gap: 6px;
  }

  #bottomNav .nav-btn svg{
    stroke: var(--brand);
    width: 46px;
    height: 46px;
    stroke-width: 2.8;
    opacity: .90;
    transition: .2s ease;
  }

  #bottomNav .nav-btn span{
    font-size: 18px;
    font-weight: 800;
    color:#444;
    transition: .2s ease;
  }

  #bottomNav .nav-btn.active span{
    color: var(--brand);
  }
  #bottomNav .nav-btn.active svg{
    opacity: 1;
    transform: scale(1.05);
  }

  #bottomNav .nav-btn:active{
    background: rgba(216, 27, 96, 0.08) !important;
  }

  /* mobile tuning */
  @media (max-width: 600px){
    body{
      padding: 10px 8px calc(var(--bottomNavH) + 38px);
    }
    th, td{
      font-size: 15px;
      padding: 11px 6px;
    }
    #productsTable td:nth-child(3){
      font-size: 17px;
    }
  }
.order-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.order-left {
  font-size: 22px;       /* üî• mai mare */
  font-weight: 700;      /* üî† un pic mai gros */
  color: #111;           /* op»õional, mai contrastant */
}

/* BUTON ANULARE ‚Äì mic, sigur, UX corect */
.cancel-btn {
  width: auto !important;
  padding: 10px 20px !important;        /* üî• mai mare pe verticalƒÉ »ôi orizontalƒÉ */
  font-size: 18px !important;           /* üî† text mai vizibil */
  border-radius: 999px !important;

  background: #fde8ef !important;
  border: 1px solid #d81b60 !important;
  color: #d81b60 !important;

  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}

.cancel-btn:hover{
  background:#d81b60 !important;
  color:#fff !important;
}
/* ===== LOGIN OVERLAY ===== */
#loginOverlay{
  position:fixed;
  inset:0;
  background:#f5f5f7;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.login-box {
  width: 95vw;                /* üî• aproape tot ecranul */
  max-width: 600px;           /* üîí limitƒÉ mare pe ecrane mari */
  background: #fff;
  border-radius: 24px;
  padding: 48px;              /* üî• dublat fa»õƒÉ de original */
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
  text-align: center;
}

.login-box h2 {
  margin-bottom: 32px;
  color: #d81b60;
  font-size: 36px;            /* üî† mare »ôi clar */
  font-weight: 800;
}

.login-box input {
  width: 100%;
  padding: 28px;              /* üî• mult mai √Ænalt */
  margin-bottom: 24px;
  border-radius: 20px;
  border: 2px solid #ccc;
  font-size: 28px;            /* üî† lizibil pe orice ecran */
}

.login-box button {
  width: 100%;
  padding: 28px;
  border-radius: 20px;
  border: none;
  background: #d81b60;
  color: #fff;
  font-size: 28px;            /* üî† clar »ôi u»ôor de apƒÉsat */
  font-weight: 900;
  cursor: pointer;
}

.login-error{
  color:#b00020;
  font-size:14px;
  margin-top:10px;
  display:none;
}
/* ============================
   WMS MOBILE MODE ‚Äì FOR»öAT
   ============================ */

body.wms-mobile{
  font-size: 22px;
}

/* TITLURI */
body.wms-mobile h3{
  font-size: 24px;
}
body.wms-mobile #orderTitle{
  font-size: 26px;
}

/* INPUT SCANARE */
body.wms-mobile #scanInput{
  font-size: 24px;
  padding: 22px;
}

/* TABEL */
body.wms-mobile th{
  font-size: 18px;
}
body.wms-mobile td{
  font-size: 20px;
  padding: 16px 12px;
}

/* NUMELE PRODUSULUI ‚Äì COL 2 (nou) */
body.wms-mobile #productsTable td:nth-child(2){
  font-size: 18px;
  font-weight: 800;
  color: #111;
}
/* RAFT ‚Äì COL 3 (actualizat) */
body.wms-mobile #productsTable td:nth-child(3){
  font-size: 22px;
  font-weight: 900;
  color: var(--brand);
  letter-spacing: 1px;
}

/* CANTITATE TOTALƒÇ ‚Äì COL 4 (MARE »òI CLAR) */
body.wms-mobile #productsTable td:nth-child(4){
  font-size: 30px;     /* üî• mare, lizibil pe terminal */
  font-weight: 900;
  color: #111;
}

/* CANTITATE SCANATƒÇ »òI RƒÇMASƒÇ ‚Äì COL 5 »ôi 6 (nicio schimbare) */
body.wms-mobile #productsTable td:nth-child(5),
body.wms-mobile #productsTable td:nth-child(6){
  font-size: 20px;
  font-weight: 800;
}

/* PROGRESS */
body.wms-mobile #progressOuter{
  height: 20px;
}
body.wms-mobile #progressText{
  font-size: 18px;
}

/* FINALIZE */
body.wms-mobile #finishBtn{
  font-size: 26px;
  padding: 26px;
}

/* BOTTOM NAV */
body.wms-mobile #bottomNav{
  height: 150px;
}
body.wms-mobile #bottomNav .nav-btn span{
  font-size: 20px;
}
body.wms-mobile #bottomNav .nav-btn svg{
  width: 60px;
  height: 60px;
}
/* ===== STATS BOOST ‚Äì WMS REAL ===== */
body.wms-mobile #statsBar{
  gap: 16px;
}

body.wms-mobile .stats-card{
  padding: 20px 18px;
  border-radius: 18px;
}

body.wms-mobile .stats-title{
  font-size: 20px;
  font-weight: 800;
}

body.wms-mobile .stats-number{
  font-size: 42px;
  font-weight: 900;
}

body.wms-mobile #pendingTotal{
  font-size: 18px !important;
  font-weight: 700 !important;
  margin-top: 6px;
}

#receptionPanel {
  padding: 20px 16px;      /* adaugƒÉ padding st√¢nga/dreapta */
  max-width: 100%;         /* eliminƒÉ limitarea artificialƒÉ */
  width: 100%;
  margin: 0;               /* scoate centrul artificial */
}

.reception-inner {
  max-width: 700px;
  margin: 0 auto;
}
.reception-header {
  padding: 10px 16px; /* spa»õiu st√¢nga + sus */
}
#scanInputReception {
  width: 100%;
  padding: 16px;
  font-size: 18px;
  margin: 16px 0;
  border-radius: 14px;
  border: 1px solid #ccc;
  background: #fff;
}
#scanResultReception {
  margin-top: 10px;
  font-weight: bold;
}


</style>
</head>

<body class="wms-mobile">
<div id="loginOverlay" style="display:none">
  <div class="login-box">
    <h2>Autentificare</h2>

    <input id="loginUser" placeholder="Utilizator">
    <input id="loginPass" type="password" placeholder="ParolƒÉ">

    <button onclick="doLogin()">IntrƒÉ</button>

    <div id="loginError" class="login-error">
      User sau parolƒÉ gre»ôitƒÉ
    </div>
  </div>
</div>

  <!-- APP HEADER -->
  <div class="app-header">
    <div class="logo-header">
      <img src="https://c.cdnmp.net/957918846/content/F%C4%83r%C4%83%20titlu%20%28192%20x%20192%20px%29%20%284%29.png" alt="Nailly Logo">
    </div>
    <div class="app-header-title">
      <strong>Nailly ‚Äì Pick &amp; Pack PRO</strong>
      <span>Scan &amp; pack mai rapid</span>
    </div>
  </div>

  <!-- STATS -->
  <div id="statsBar">
    <div id="pendingBox" class="stats-card stats-pending--none">
<span class="stats-title">‚ö†Ô∏è Status comenzi</span>
      <span class="stats-number" id="pendingCount">0</span>
      <span>comenzi de pregƒÉtit</span><span id="pendingTotal" style="display:block; font-size:15px; font-weight:500; color:#333;">
  Total: 0 RON
</span>

    </div>
    <div id="doneBox" class="stats-card stats-done">
<span class="stats-title">‚úîÔ∏è Activitatea de astƒÉzi</span>
      <span class="stats-number" id="doneCount">0</span>
      <span>comenzi finalizate</span>
    </div>
  </div>

  <h3 id="orderTitle"></h3>

  <div id="orderMeta">
    <div id="orderInfoRow">
      <span id="orderCode"></span>
      <span id="timerBox">Timp: <span id="timer">00:00</span></span>
    </div>
    <div id="progressOuter"><div id="progressInner"></div></div>
    <div id="progressText"></div>
  </div>

  <h3>Pas 2: ScaneazƒÉ produsele</h3>

  <input id="scanInput"
         placeholder="ScaneazƒÉ EAN / SKU..."
         disabled />

  <button id="cameraBtn" onclick="startCameraScan()">ScaneazƒÉ cu camera telefonului</button>

  <div id="cameraScanner"></div>

  <table id="productsTable">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Produs</th>
        <th>Raft</th>
        <th>Cantitate</th>
        <th>Scanat</th>
        <th>RƒÉmas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="finishBtn" onclick="finalizeOrder()">FinalizeazƒÉ comanda</button>

  <!-- ORDERS PANEL -->
  <div id="ordersPanel" class="orders-panel">
    <div class="orders-panel-header">
      <div>Comenzi √Æn pregƒÉtire</div>
      <button class="close-btn" onclick="closeOrdersPanel()">‚úï</button>
    </div>
    <div id="ordersPanelList" class="orders-panel-list"></div>
  </div>

<!-- RECEPTION PANEL -->
<div id="receptionPanel" style="display:none;">


  <!-- Con»õinutul centrat -->
  <div class="reception-inner">

    <!-- ‚úÖ C√¢mpul de scanare (mai mare + stil direct) -->
    <input
  id="scanInputReception"
  placeholder="ScaneazƒÉ EAN / SKU..."
  readonly
  autocomplete="off"
/>




    <!-- Afi»ôare rezultat scanare -->
    <div id="scanResultReception"></div>

  </div>
</div>

  <!-- QUICK SEARCH OVERLAY -->
  <div id="quickSearchOverlay">
    <div class="quickSearchBox">
      <div class="quickSearchInputWrap">
        <input id="quickSearchInput" placeholder="Scrie numƒÉrul comenzii‚Ä¶" inputmode="numeric" autocomplete="off">
        <button id="quickSearchBtn" type="button" title="CautƒÉ">üîç</button>
        <div id="quickSearchClose" title="√énchide">√ó</div>
        <div id="quickSearchResults"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV PRO -->
  <div id="bottomNav">
    <button id="btnHome" class="nav-btn active" title="AcasƒÉ">
      <svg viewBox="0 0 24 24" fill="none" stroke="#D81B60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <polyline points="1 20 1 14 7 14"></polyline>
        <path d="M3.51 9a9 9 0 0114.13-3.36L23 10"></path>
        <path d="M20.49 15a9 9 0 01-14.13 3.36L1 14"></path>
      </svg>
      <span>AcasƒÉ</span>
    </button>

    <button id="btnOrders" class="nav-btn" title="Comenzi">
      <svg viewBox="0 0 24 24" fill="none" stroke="#D81B60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 5H21V19H9z"></path>
        <polyline points="9 3 5 3 5 21 21 21"></polyline>
      </svg>
      <span>Comenzi</span>
    </button>

<button id="btnReception" class="nav-btn" title="Recep»õie">
  <svg viewBox="0 0 24 24" fill="none" stroke="#D81B60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
    <polyline points="7 10 12 15 17 10" />
    <line x1="12" y1="15" x2="12" y2="3" />
  </svg>
  <span>Recep»õie</span>
</button>

    <button id="btnSearch" class="nav-btn" title="CautƒÉ">
      <svg viewBox="0 0 24 24" fill="none" stroke="#D81B60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <span>CautƒÉ</span>
    </button>

  </div>

  <!-- CAMERA LIB -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
/* ===================== CONFIG ====================== */
const ORDER_LIST_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/orders-list";
const ORDER_GET_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/order-get";
const DELETE_ORDER_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/delete-order-file-orderId-";
const PRODUCT_LOCATION_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?sku=eq.";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bXFmc2lneGVjbXJ5Z21ib2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNDQ0MzgsImV4cCI6MjA3NTYyMDQzOH0.b9MXrgxADVZGvdFaKFQggD-vMd0ayZ9hX4_PmYOzrfE";

let currentProducts = [];
let currentOrderId = null;
let allOrders = [];
let timerInterval = null;
let orderStartTime = null;

/* ===================== HELPER: DATE KEY ====================== */
function getTodayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `nailly_pnp_done_${y}${m}${day}`;
}

/* ===================== SCAN HELPERS (SHARED) ===================== */

/* normalizeazƒÉ inputul brut de la scanner */
function normalizeScanInput(raw) {
  if (!raw) return "";

  let s = String(raw).trim();
  s = s.replace(/^\]C1/, ""); // GS1 prefix
  s = s.replace(/\D/g, "");   // doar cifre
  return s;
}

/* genereazƒÉ variante tolerate (11 / 12 / 13 cifre) */
function generateScanVariants(code) {
  if (!code) return [];

  const variants = new Set();
  const s = String(code).trim();

  // üëâ dacƒÉ NU e numeric => SKU
  if (!/^\d+$/.test(s)) {
    variants.add(s);                // exact
    variants.add(s.toUpperCase());  // siguran»õƒÉ
    return [...variants];
  }

  // üëâ dacƒÉ e numeric => EAN
  variants.add(s);

  const noLeadingZero = s.replace(/^0+/, "");
  variants.add(noLeadingZero);

  if (noLeadingZero.length === 12) {
    variants.add("0" + noLeadingZero);
  }

  if (noLeadingZero.length === 11) {
    variants.add("0" + noLeadingZero);
    variants.add("0" + noLeadingZero + "0");
  }

  if (s.length > 1) {
    variants.add(s.slice(0, -1));
    variants.add(("0" + s).slice(0, 13));
  }

  return [...variants];
}

/* ===================== AUDIO + VIBRA»öIE ====================== */
function playBeep(freq = 800, duration = 120, type = "sine") {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration / 1000);
    osc.stop(ctx.currentTime + duration / 1000 + 0.02);
  } catch (e) {}
}
function feedbackSuccess() {
  playBeep(900, 100, "square");
  if (navigator.vibrate) navigator.vibrate(40);
}
function feedbackError() {
  playBeep(220, 200, "sawtooth");
  if (navigator.vibrate) navigator.vibrate([0, 80, 40, 80]);
}

/* ===================== TIMER ====================== */
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  orderStartTime = Date.now();
  const timerEl = document.getElementById("timer");
  timerEl.textContent = "00:00";

  timerInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - orderStartTime) / 1000);
    const mm = String(Math.floor(diff / 60)).padStart(2, "0");
    const ss = String(diff % 60).padStart(2, "0");
    timerEl.textContent = `${mm}:${ss}`;
  }, 1000);
}
function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

/* ===================== STATS ====================== */
function updateStats() {
  const pendingBox = document.getElementById("pendingBox");
  const pendingCountEl = document.getElementById("pendingCount");
  const doneCountEl = document.getElementById("doneCount");

  const pending = Array.isArray(allOrders) ? allOrders.length : 0;
  pendingCountEl.textContent = pending;
let totalAmount = 0;

allOrders.forEach(o => {
  totalAmount += Number(o.total_amount || o.subtotal_amount || 0);
});

const formattedTotal = totalAmount.toLocaleString("ro-RO", {
  style: "currency",
  currency: "RON",
  minimumFractionDigits: 2
});

document.getElementById("pendingTotal").textContent = `Total: ${formattedTotal}`;

  pendingBox.classList.remove("stats-pending--some", "stats-pending--none");
  if (pending > 0) pendingBox.classList.add("stats-pending--some");
  else pendingBox.classList.add("stats-pending--none");

  const key = getTodayKey();
  const done = Number(localStorage.getItem(key) || "0");
  doneCountEl.textContent = done;
}

/* ===================== LOAD ORDERS ====================== */
async function loadOrders({silent=false} = {}) {
  try {
    const res = await fetch(ORDER_LIST_URL, { cache: "no-store" });
    const orders = await res.json();
console.log("Comenzi √ÆncƒÉrcate:", orders);
    allOrders = Array.isArray(orders) ? orders : [];
    updateStats();
    if (document.getElementById("ordersPanel").classList.contains("open")) {
      renderOrdersPanel();
    }
  } catch (err) {
    console.error(err);
    if (!silent) alert("Eroare la √ÆncƒÉrcarea comenzilor!");
  }
}

async function loadOrderById(orderId) {
  if (!orderId) return;

  const exists = allOrders.some(o => String(o.orderId) === String(orderId));
  if (!exists) {
    feedbackError();
    alert("Comanda nu existƒÉ √Æn lista de pregƒÉtit. VerificƒÉ numƒÉrul.");
    return;
  }

  currentOrderId = String(orderId);

  const res = await fetch(
    `${ORDER_GET_URL}?orderId=${encodeURIComponent(currentOrderId)}`,
    { cache: "no-store" }
  );
  const data = await res.json();

  const products = (data.line_items || []).filter(p => p.item_type === "product");

   /* ===================== üî• 1. COLECTƒÇM TOATE SKU-URILE ===================== */
const skuList = [
  ...new Set(
    products
      .map(p => String(p.product_sku || "").replace(/^0+/, ""))
      .filter(Boolean)
  )
];

/* ===================== üî• 2. UN SINGUR FETCH LA SUPABASE ===================== */
let locationMap = new Map();

if (skuList.length) {
  // Normalizare SKU (fƒÉrƒÉ 0 la √Ænceput)
  const cleanSkus = skuList.map(sku => String(sku).replace(/^0+/, ""));

  const url = `https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?sku=in.(${cleanSkus.map(sku => `"${encodeURIComponent(sku)}"`).join(",")})`;

  console.log("[DEBUG] URL loca»õii produse:", url); // ajutƒÉ la debugging

  const locRes = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`
    }
  });

  const locData = await locRes.json().catch(() => []);

  locData.forEach(row => {
    if (row.sku && row.location && row.location !== "EMPTY") {
      locationMap.set(String(row.sku), row.location);
    }
  });
}



  /* ===================== üî• 3. CONSTRUIM PRODUSELE ===================== */
  currentProducts = products.map(p => {
    const originalSku = p.product_sku || "";
    const lookupSku = String(originalSku).replace(/^0+/, "");

    return {
      sku: originalSku,
      ean: p.product_ean,
      name: p.product_name,
      qty: Number(p.quantity),
      shelf: locationMap.get(lookupSku) || "FƒÉrƒÉ loca»õie",
      scanned: 0
    };
  });

  /* ===================== SORTARE ===================== */
  currentProducts.sort((a, b) => {
    if (a.shelf === b.shelf) {
      return String(a.sku).localeCompare(String(b.sku));
    }
    return String(a.shelf).localeCompare(String(b.shelf));
  });

  /* ===================== UI ===================== */
  document.getElementById("orderTitle").textContent = "Comanda #" + currentOrderId;
  document.getElementById("orderCode").textContent = "ID comandƒÉ: " + currentOrderId;
  document.getElementById("orderMeta").style.display = "block";

  const scanInput = document.getElementById("scanInput");
  scanInput.disabled = false;
  scanInput.value = "";
  scanInput.focus();

  scanInput.removeEventListener("input", handleScanAuto);
  scanInput.addEventListener("input", handleScanAuto);

  setTimeout(() => {
    scanInput.setAttribute("inputmode", "none");
    scanInput.removeAttribute("readonly");
  }, 50);

  if (!scanInput.dataset.manualEnabled) {
    scanInput.addEventListener("click", function () {
      this.removeAttribute("readonly");
      this.removeAttribute("inputmode");
      this.focus();
    });
    scanInput.dataset.manualEnabled = "1";
  }

  const finishBtn = document.getElementById("finishBtn");
  finishBtn.style.display = "block";
  finishBtn.classList.remove("active");

  startTimer();
  renderTable();
}


/* ===================== TABLE ====================== */
function renderTable() {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";

  const nextIndex = currentProducts.findIndex(p => p.scanned < p.qty);

  currentProducts.forEach((p, index) => {
    const tr = document.createElement("tr");
    if (index === nextIndex) tr.classList.add("next-row");
    if (p.scanned === p.qty) tr.classList.add("ok");

    tr.innerHTML = `
      <td>${p.sku ?? ""}</td>
      <td>${p.name ?? ""}</td>
      <td>${p.shelf ?? ""}</td>
      <td>${p.qty}</td>
      <td>${p.scanned}</td>
      <td>${p.qty - p.scanned}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalQty = currentProducts.reduce((s, p) => s + p.qty, 0);
  const totalScanned = currentProducts.reduce((s, p) => s + p.scanned, 0);
  const pct = totalQty > 0 ? Math.round((totalScanned / totalQty) * 100) : 0;

  document.getElementById("progressInner").style.width = pct + "%";
  document.getElementById("progressText").textContent =
    `Progres: ${totalScanned}/${totalQty} (${pct}%)`;

  updateFinishButtonState();

  /* üî• SCROLL AUTOMAT LA URMƒÇTORUL PRODUS */
  setTimeout(() => {
    const nextRow = document.querySelector("#productsTable .next-row");
    if (!nextRow) return;

    const rowRect = nextRow.getBoundingClientRect();
    const absoluteTop = rowRect.top + window.pageYOffset;

    window.scrollTo({
      top: absoluteTop - 120, // offset ca sƒÉ fie vizibil clar
      behavior: "smooth"
    });
  }, 120); // delay pentru a permite DOM-ul sƒÉ se randeze complet
}
function updateFinishButtonState() {
  const allScanned = currentProducts.length > 0 &&
    currentProducts.every(p => p.scanned >= p.qty);

  const btn = document.getElementById("finishBtn");
  if (allScanned) btn.classList.add("active");
  else btn.classList.remove("active");
}
/* ===================== SCAN CONTEXT RESET ====================== */
function resetScanContext() {
  const scanInput = document.getElementById("scanInput");
  if (!scanInput) return;

  scanInput.value = "";
  scanInput.disabled = false;

  // reset complet focus + listener
  scanInput.blur();
  scanInput.removeEventListener("input", handleScanAuto);
  scanInput.addEventListener("input", handleScanAuto);

  // rearmare scanner hardware
  setTimeout(() => {
    scanInput.setAttribute("inputmode", "none");
    scanInput.removeAttribute("readonly");
    scanInput.focus();
  }, 80);
}

/* ===================== SCAN ====================== */
function normalizeVariants(v) {
  if (!v) return [];

  const s = String(v).trim();
  const variants = new Set();

  variants.add(s);                     // original
  variants.add(s.replace(/^0+/, ""));  // fƒÉrƒÉ 0 √Æn fa»õƒÉ

  if (s.length > 1) {
    variants.add(s.slice(0, -1));      // fƒÉrƒÉ ultima cifrƒÉ
    variants.add(s.replace(/^0+/, "").slice(0, -1)); // fƒÉrƒÉ 0 + fƒÉrƒÉ ultima
  }

  return [...variants].filter(Boolean);
}

function handleScan(event) {
  if (event.key !== "Enter") return;

  const raw = normalizeScanInput(event.target.value);
  event.target.value = "";

  const scannedVariants = generateScanVariants(raw);

  let found = currentProducts.find(p => {
    const skuVariants = generateScanVariants(p.sku);
    const eanVariants = generateScanVariants(p.ean);


    return scannedVariants.some(v =>
      skuVariants.includes(v) || eanVariants.includes(v)
    );
  });

  if (!found) {
    feedbackError();
    flashError();
    return;
  }

  if (found.scanned < found.qty) {
    found.scanned++;
    feedbackSuccess();
    renderTable();
  } else {
    feedbackError();
    flashError();
  }
}

function flashError() {
  let input = document.getElementById("scanInput");
  input.classList.add("errorInput");
  setTimeout(() => input.classList.remove("errorInput"), 280);
}
let scanTimer = null;

function handleScanAuto(e) {
  clearTimeout(scanTimer);

  scanTimer = setTimeout(() => {
    const code = (e.target.value || "").trim();
    if (!code) return;

    e.target.value = "";
    handleScan({ key: "Enter", target: { value: code } });
  }, 200); // a»ôteaptƒÉ pu»õin dupƒÉ ce ai scris
}

/* ===================== CAMERA SCAN ====================== */
function startCameraScan() {
  const div = document.getElementById("cameraScanner");
  div.style.display = "block";

  const html5QrCode = new Html5Qrcode("cameraScanner");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 260, height: 160 } },
    (decodedText) => {
      document.getElementById("scanInput").value = decodedText;
      handleScan({ key: "Enter", target: { value: decodedText } });

      html5QrCode.stop().then(() => {
        div.style.display = "none";
      }).catch(() => {
        div.style.display = "none";
      });
    }
  ).catch(err => {
    console.error(err);
    alert("Camera nu a putut porni. VerificƒÉ permisiunile.");
    div.style.display = "none";
  });
}

/* ===================== FINALIZE ORDER ====================== */
async function finalizeOrder() {
  const btn = document.getElementById("finishBtn");

  if (!btn.classList.contains("active")) {
    alert("Trebuie sƒÉ scanezi toate produsele!");
    return;
  }
  if (!currentOrderId) {
    alert("Nu existƒÉ comandƒÉ √ÆncƒÉrcatƒÉ!");
    return;
  }
  if (!confirm("Finalizezi comanda?")) return;

  try {
    const res = await fetch(DELETE_ORDER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId: currentOrderId }),
    });

    const result = await res.json().catch(() => ({}));

    if (res.ok && result.deleted?.length > 0) {
      alert("Comanda a fost finalizatƒÉ!");

      const key = getTodayKey();
      const prev = Number(localStorage.getItem(key) || "0");
      localStorage.setItem(key, String(prev + 1));

      stopTimer();
      currentProducts = [];
      currentOrderId = null;

      document.getElementById("orderTitle").textContent = "";
      document.getElementById("orderMeta").style.display = "none";
      document.querySelector("#productsTable tbody").innerHTML = "";

      const scanInput = document.getElementById("scanInput");
      scanInput.value = "";
      scanInput.disabled = true;

      btn.style.display = "none";
      btn.classList.remove("active");

      await loadOrders({silent:true});
      setTimeout(() => location.reload(), 400);

    } 
      
      else {
      alert("Eroare la »ôtergerea fi»ôierului!");
      console.error(result);
    }
  } catch (err) {
    console.error(err);
    alert("Eroare la server!");
  }
}
async function cancelOrder(orderId, event){
  event.stopPropagation(); // nu deschide comanda

  if(!confirm("Sigur vrei sƒÉ marchezi comanda ca ANULATƒÇ?")) return;

  try{
    const res = await fetch(DELETE_ORDER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId })
    });

    const result = await res.json().catch(() => ({}));

    if(res.ok){
      alert("Comanda a fost anulatƒÉ.");

      // reset stare curentƒÉ dacƒÉ era √ÆncƒÉrcatƒÉ
      if(String(currentOrderId) === String(orderId)){
        stopTimer();
        currentProducts = [];
        currentOrderId = null;

        document.getElementById("orderTitle").textContent = "";
        document.getElementById("orderMeta").style.display = "none";
        document.querySelector("#productsTable tbody").innerHTML = "";

        const scanInput = document.getElementById("scanInput");
        scanInput.value = "";
        scanInput.disabled = true;

        const btn = document.getElementById("finishBtn");
        btn.style.display = "none";
        btn.classList.remove("active");
      }

      await loadOrders({ silent:true });
      updateStats();
    } else {
      alert("Eroare la anularea comenzii!");
      console.error(result);
    }
  } catch(err){
    console.error(err);
    alert("Eroare server la anulare!");
  }
}

/* ===================== ORDERS PANEL ====================== */
function openOrdersPanel() {
  document.getElementById("ordersPanel").classList.add("open");
  renderOrdersPanel();
}
function closeOrdersPanel() {
  document.getElementById("ordersPanel").classList.remove("open");
}

function toggleOrdersPanel(){
  const panel = document.getElementById("ordersPanel");
  if (panel.classList.contains("open")) {
    closeOrdersPanel();
  } else {
    openOrdersPanel();
  }
}

function renderOrdersPanel() {
  const list = document.getElementById("ordersPanelList");
  list.innerHTML = "";

  if (!allOrders.length) {
    list.innerHTML = "<div style='padding:16px;color:#666'>Nu existƒÉ comenzi.</div>";
    return;
  }

  allOrders.forEach(o => {
    const div = document.createElement("div");
div.className = "order-row";

div.innerHTML = `
  <div class="order-left">
    Comanda #${o.orderId}
  </div>
  <button class="cancel-btn" onclick="cancelOrder('${o.orderId}', event)">
    AnulatƒÉ
  </button>
`;

    div.onclick = () => {
      closeOrdersPanel();
      closeQS();
      loadOrderById(o.orderId);
      setActiveNav("btnOrders");
    };
    list.appendChild(div);
  });
}

/* ===================== QUICK SEARCH ====================== */
const qs = {
  overlay: null,
  input: null,
  btn: null,
  close: null,
  results: null
};

function openQS(){
  qs.overlay.classList.add("active");
  qs.input.value = "";
  qs.results.innerHTML = "";
  qs.results.classList.remove("show");
  setTimeout(() => qs.input.focus(), 60);
}
function closeQS(){
  qs.overlay.classList.remove("active");
  qs.input.value = "";
  qs.results.innerHTML = "";
  qs.results.classList.remove("show");
}

function renderQSResults(matches){
  qs.results.innerHTML = "";
  if (!matches.length) {
    qs.results.classList.remove("show");
    return;
  }
  qs.results.classList.add("show");

  matches.slice(0, 10).forEach(o => {
    const div = document.createElement("div");
    div.className = "quick-search-item";
    div.textContent = `Comanda #${o.orderId}`;
    div.onclick = () => {
      closeQS();
      loadOrderById(o.orderId);
      setActiveNav("btnSearch");
    };
    qs.results.appendChild(div);
  });
}

function qsHandleInput(){
  const v = (qs.input.value || "").trim();
  if (!v) {
    qs.results.innerHTML = "";
    qs.results.classList.remove("show");
    return;
  }
  const matches = allOrders.filter(o => String(o.orderId).includes(v));
  renderQSResults(matches);
}

function qsRunSearch(){
  const v = (qs.input.value || "").trim();
  if (!v) return;
  closeQS();
  loadOrderById(v);
  setActiveNav("btnSearch");
}

/* ===================== NAV STATE ====================== */
function setActiveNav(id){
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  const btn = document.getElementById(id);
  if (btn) btn.classList.add("active");
}

/* ===================== HOME REFRESH ====================== */
function refreshHome(){
  closeOrdersPanel();
  closeQS();

  stopTimer();
  currentProducts = [];
  currentOrderId = null;

  document.getElementById("orderTitle").textContent = "";
  document.getElementById("orderMeta").style.display = "none";
  document.querySelector("#productsTable tbody").innerHTML = "";

  const scanInput = document.getElementById("scanInput");
   scanInput.value = "";
scanInput.focus();

  const btn = document.getElementById("finishBtn");
  btn.style.display = "none";
  btn.classList.remove("active");

  loadOrders({ silent: true });
  updateStats();
  feedbackSuccess();
}

/* ===================== INIT ====================== */
document.addEventListener("DOMContentLoaded", () => {
  qs.overlay = document.getElementById("quickSearchOverlay");
  qs.input = document.getElementById("quickSearchInput");
  qs.btn = document.getElementById("quickSearchBtn");
  qs.close = document.getElementById("quickSearchClose");
  qs.results = document.getElementById("quickSearchResults");

  qs.btn.addEventListener("click", qsRunSearch);
  qs.close.addEventListener("click", closeQS);
  qs.overlay.addEventListener("click", (e) => { if (e.target === qs.overlay) closeQS(); });

  qs.input.addEventListener("input", qsHandleInput);
  qs.input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") qsRunSearch();
    if (e.key === "Escape") closeQS();
  });

  document.getElementById("btnHome").addEventListener("click", () => {
    setActiveNav("btnHome");
    refreshHome();
  });
  document.getElementById("btnOrders").addEventListener("click", () => {
    setActiveNav("btnOrders");
    toggleOrdersPanel();
  });
  document.getElementById("btnSearch").addEventListener("click", () => {
    setActiveNav("btnSearch");
    openQS();
  });

  loadOrders({silent:true});
});

document.getElementById("btnReception").addEventListener("click", () => {
  setActiveNav("btnReception");
  showReceptionPanel();
});

function showReceptionPanel() {
  const receptionPanel = document.getElementById("receptionPanel");
  const isVisible = receptionPanel.style.display === "block";

  if (isVisible) {
    location.reload();
    return;
  }

  // üîì AratƒÉ Recep»õia
  receptionPanel.style.display = "block";

  // üîí Ascunde restul
  document.getElementById("ordersPanel").style.display = "none";
  document.getElementById("productsTable").style.display = "none";
  document.getElementById("scanInput").style.display = "none";
  document.getElementById("cameraBtn").style.display = "none";
  document.getElementById("finishBtn").style.display = "none";
  document.getElementById("orderMeta").style.display = "none";

  document.getElementById("orderTitle").textContent = "Modul Recep»õie";
  setActiveNav("btnReception");

  // üî• FOCUS GARANTAT (dupƒÉ user click)
  setTimeout(() => {
    const input = document.getElementById("scanInputReception");
    if (input) {
      input.focus();
      input.select();
    }
  }, 80);
}


/* refresh automat la 30 sec */
setInterval(() => loadOrders({silent:true}), 30000);
</script>
<script>
/* =====================================
   LOGIN WMS NAILLY ‚Äì STABIL & CONTROLAT
   - Login o datƒÉ pe zi / device
   - FƒÉrƒÉ flicker / fƒÉrƒÉ layout jump
   - FƒÉrƒÉ reload la pull-to-refresh
   ===================================== */

const LOGIN_USER = "nailly";
const LOGIN_PASS = "0604";

/* helper: data de azi (format stabil) */
function getLoginDayKey() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

/* aratƒÉ/ascunde overlay fƒÉrƒÉ sƒÉ for»õeze reflow aiurea */
function hideOverlay(overlay) {
  if (!overlay) return;
  overlay.style.display = "none";
  overlay.style.visibility = "hidden";
  overlay.style.opacity = "0";
}

function showOverlay(overlay) {
  if (!overlay) return;
  overlay.style.display = "flex";   // dacƒÉ overlay-ul tƒÉu e pe flex
  overlay.style.visibility = "visible";
  overlay.style.opacity = "1";
}

/* LOGIN */
function doLogin() {
  const uEl = document.getElementById("loginUser");
  const pEl = document.getElementById("loginPass");
  const overlay = document.getElementById("loginOverlay");
  const err = document.getElementById("loginError");

  const u = (uEl?.value || "").trim();
  const p = (pEl?.value || "").trim();

  if (u === LOGIN_USER && p === LOGIN_PASS) {
    localStorage.setItem("nailly_logged", "1");
    localStorage.setItem("nailly_login_day", getLoginDayKey());

    if (err) err.style.display = "none";
    hideOverlay(overlay);
  } else {
    if (err) err.style.display = "block";
  }
}

/* LOGOUT (op»õional) */
function doLogout() {
  localStorage.removeItem("nailly_logged");
  localStorage.removeItem("nailly_login_day");
  location.reload();
}

/* VERIFICARE LOGIN ‚Äì ruleazƒÉ DUPƒÇ ce UI e √ÆncƒÉrcat (fƒÉrƒÉ sƒÉ-»õi taie logo-ul) */
window.addEventListener("load", () => {
  const overlay = document.getElementById("loginOverlay");
  if (!overlay) return;

  const logged = localStorage.getItem("nailly_logged") === "1";
  const loginDay = localStorage.getItem("nailly_login_day");
  const today = getLoginDayKey();

  if (logged && loginDay === today) {
    hideOverlay(overlay);
  } else {
    // device nou / zi nouƒÉ => cere login
    localStorage.removeItem("nailly_logged");
    localStorage.removeItem("nailly_login_day");
    showOverlay(overlay);
  }
});
</script>
<script>
/* ===================== RECEPTIE ‚Äì SCANARE PRODUSE (FINAL PRO) ===================== */

const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bXFmc2lneGVjbXJ5Z21ib2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNDQ0MzgsImV4cCI6MjA3NTYyMDQzOH0.b9MXrgxADVZGvdFaKFQggD-vMd0ayZ9hX4_PmYOzrfE";

const scanInput = document.getElementById("scanInputReception");
const resultBox = document.getElementById("scanResultReception");

let scanTimer = null;

if (!scanInput || !resultBox) return;

/* ===================== NORMALIZARE ===================== */
function normalizeScanInput(raw) {
  if (!raw) return "";
  let s = String(raw).trim();
  s = s.replace(/^\]C1/, "");
  s = s.replace(/\D/g, "");
  return s;
}

/* ===================== UI ===================== */
function showReceptionLocation(location) {
  resultBox.innerHTML = `
    <div style="
      background:#e8f7e9;
      padding:22px;
      border-radius:16px;
      font-size:32px;
      font-weight:900;
      color:#1e7e34;
      margin-top:14px;
    ">
      üìç ${location}
    </div>
  `;
}

/* ===================== FETCH ===================== */
async function fetchLocationByCode(codeRaw) {
  resultBox.innerHTML = "üîç Caut loca»õia...";

  const headers = {
    apikey: SUPABASE_KEY,
    Authorization: `Bearer ${SUPABASE_KEY}`,
  };

  const variants = generateScanVariants(codeRaw);

  for (const v of variants) {

    let res = await fetch(
      `https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?sku=eq.${encodeURIComponent(v)}&select=location`,
      { headers }
    );
    if (res.ok) {
      const d = await res.json();
      if (d?.length && d[0].location && d[0].location !== "EMPTY") {
        showReceptionLocation(d[0].location);
        return;
      }
    }

    res = await fetch(
      `https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?ean=eq.${encodeURIComponent(v)}&select=location`,
      { headers }
    );
    if (res.ok) {
      const d = await res.json();
      if (d?.length && d[0].location && d[0].location !== "EMPTY") {
        showReceptionLocation(d[0].location);
        return;
      }
    }

    if (v.length <= 11) {
      res = await fetch(
        `https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?ean=like.*${v}*&select=location`,
        { headers }
      );
      if (res.ok) {
        const d = await res.json();
        if (d?.length && d[0].location && d[0].location !== "EMPTY") {
          showReceptionLocation(d[0].location);
          return;
        }
      }
    }
  }

  resultBox.innerHTML = `
    <div style="color:#b00020;font-weight:900;font-size:22px">
      ‚ùå FƒÉrƒÉ loca»õie
    </div>
  `;
}

/* ===================== AUTO ENTER (SCANNER) ===================== */
scanInput.addEventListener("input", (e) => {
  clearTimeout(scanTimer);

  scanTimer = setTimeout(() => {
    const raw = normalizeScanInput(e.target.value);
    if (!raw) return;

    e.target.value = "";
    fetchLocationByCode(raw);
  }, 120);
});

/* ===================== MANUAL OVERRIDE ===================== */
// dacƒÉ dai click -> po»õi scrie manual
scanInput.addEventListener("click", () => {
  scanInput.removeAttribute("readonly");
  scanInput.focus();
});

// dupƒÉ blur -> revine √Æn mod scanner
scanInput.addEventListener("blur", () => {
  setTimeout(() => {
    scanInput.setAttribute("readonly", "readonly");
  }, 200);
});
</script>



</body>
</html>


