<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<title>Nailly â€“ Pick & Pack</title>

<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
    }
    h1 { color: #d81b60; }
    select, button, input {
        padding: 10px;
        font-size: 16px;
        margin: 5px 0;
        width: 100%;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    table, td, th {
        border: 1px solid #ccc;
    }
    th, td {
        padding: 10px;
        text-align: left;
    }
    .ok { background: #c8f7c5; }
    .error { background: #f7c5c5; }
</style>
</head>

<body>

<h1>Nailly â€“ Pick & Pack</h1>

<h3>Pas 1: SelecteazÄƒ comanda</h3>
<select id="orderList">
    <option>Se Ã®ncarcÄƒ comenzile...</option>
</select>
<button onclick="loadOrder()">ÃŽncarcÄƒ comanda</button>

<h3 id="orderTitle"></h3>

<!-- NEW â€“ Buton Finalizare -->
<button id="finishBtn" onclick="finalizeOrder()" style="display:none; background:#d81b60; color:white;">
    FinalizeazÄƒ comanda
</button>

<h3>Pas 2: ScaneazÄƒ produsele</h3>

<input id="scanInput" placeholder="ScaneazÄƒ EAN / SKU..." 
       onkeypress="handleScan(event)" disabled />

<button onclick="startCameraScan()" style="margin-top:10px;">
    ScaneazÄƒ cu camera telefonului
</button>

<div id="cameraScanner" style="width:100%; margin-top:10px; display:none;"></div>

<table id="productsTable">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Produs</th>
            <th>Raft</th> <!-- NEW -->
            <th>Cantitate</th>
            <th>Scanat</th>
            <th>RÄƒmas</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
// ================================
// URL-URI FUNCÈšII SUPABASE
// ================================
const ORDER_LIST_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/orders-list";

const ORDER_GET_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/order-get";

const DELETE_ORDER_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/delete-order-file-orderId"; // NEW

// ðŸ”¥ Conexiune Supabase (pentru locaÈ›ii)
const SUPABASE_URL = "https://yvmqfsigxecmrygmbolg.supabase.co";
const SUPABASE_KEY = "public-anon-key"; // pune cheia publicÄƒ din Project Settings â†’ API

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
// =====================================================

let currentProducts = [];
let currentOrderId = null;

// ================================
// 1. ÃŽNCARCÄ‚ LISTA DE COMENZI
// ================================
async function loadOrders() {
    try {
        const res = await fetch(ORDER_LIST_URL);
        const orders = await res.json();
        const select = document.getElementById("orderList");

        select.innerHTML = "";

        orders.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o.orderId;
            opt.textContent = "Comanda #" + o.orderId;
            select.appendChild(opt);
        });

    } catch (e) {
        alert("Nu pot Ã®ncÄƒrca comenzile!");
        console.error(e);
    }
}

// ================================
// 2. ÃŽNCARCÄ‚ O COMANDÄ‚ + LOCAÈšII
// ================================
async function loadOrder() {
    currentOrderId = document.getElementById("orderList").value;
    if (!currentOrderId) return;

    const res = await fetch(`${ORDER_GET_URL}?orderId=${currentOrderId}`);
    const data = await res.json();

    // Produit + locaÈ›ii raft
    currentProducts = await Promise.all(
        data.line_items
            .filter(p => p.item_type === "product")
            .map(async p => {
                // CÄƒutÄƒm locaÈ›ia Ã®n tabel
                let loc = await supabase
                    .from("product_locations")
                    .select("location")
                    .eq("sku", p.product_sku)
                    .maybeSingle();

                return {
                    sku: p.product_sku,
                    ean: p.product_ean,
                    name: p.product_name,
                    qty: Number(p.quantity),
                    scanned: 0,
                    location: loc.data?.location || "FÄƒrÄƒ locaÈ›ie"
                };
            })
    );

    document.getElementById("orderTitle").textContent = "Comanda #" + currentOrderId;
    document.getElementById("scanInput").disabled = false;
    document.getElementById("scanInput").focus();

    document.getElementById("finishBtn").style.display = "block"; // NEW

    renderTable();
}

// ================================
// 3. AFIÈ˜ARE TABEL
// ================================
function renderTable() {
    const tbody = document.querySelector("#productsTable tbody");
    tbody.innerHTML = "";

    currentProducts.forEach(p => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${p.sku}</td>
            <td>${p.name}</td>
            <td><b>${p.location}</b></td>
            <td>${p.qty}</td>
            <td>${p.scanned}</td>
            <td>${p.qty - p.scanned}</td>
        `;

        if (p.scanned === p.qty) tr.classList.add("ok");
        tbody.appendChild(tr);
    });
}

// ================================
// 4. LOGICÄ‚ SCANARE
// ================================
function handleScan(event) {
    if (event.key !== "Enter") return;

    const code = event.target.value.trim();
    event.target.value = "";

    let found = currentProducts.find(p => p.sku === code || p.ean === code);

    if (!found) return flashError();

    if (found.scanned < found.qty) {
        found.scanned++;
        renderTable();
    } else {
        flashError();
    }
}

// ================================
// FINALIZARE COMANDÄ‚ â€“ NEW
// ================================
async function finalizeOrder() {
    if (!currentOrderId) return;

    if (!confirm("EÈ™ti sigur cÄƒ finalizezi comanda?")) return;

    const res = await fetch(DELETE_ORDER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId: currentOrderId })
    });

    const msg = await res.json();
    console.log(msg);

    alert("Comanda a fost finalizatÄƒ!");

    // Reset UI
    currentOrderId = null;
    currentProducts = [];
    document.querySelector("#productsTable tbody").innerHTML = "";
    document.getElementById("orderTitle").textContent = "";
    document.getElementById("finishBtn").style.display = "none";

    loadOrders();
}

// ================================
function flashError() {
    let input = document.getElementById("scanInput");
    input.classList.add("error");
    setTimeout(() => input.classList.remove("error"), 400);
}

// ================================
loadOrders();
</script>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

</body>
</html>
