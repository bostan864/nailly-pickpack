<!DOCTYPE html>
<html lang="ro">

<head>
<meta charset="UTF-8" />
<title>Nailly â€“ Pick & Pack</title>

<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding-bottom: 110px;
    }

    h1 {
        color: #d81b60;
        font-size: 28px;
        text-align: center;
        margin-bottom: 25px;
    }

    h3 {
        margin-top: 25px;
        font-size: 20px;
    }

    select, input {
        padding: 16px;
        font-size: 18px;
        margin: 10px 0;
        width: 100%;
        border-radius: 10px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }

    button {
        padding: 18px;
        font-size: 20px;
        width: 100%;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        background: #d81b60;
        color: white;
        transition: 0.25s;
    }

    button:hover {
        background: #b0144f;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        table-layout: fixed;
    }

    th, td {
        padding: 12px;
        border: 1px solid #ccc;
        word-wrap: break-word;
        white-space: normal;
        font-size: 16px;
    }

    .ok {
        background: #c8f7c5 !important;
    }

    .errorInput {
        background: #ffcccc !important;
    }

    #finishBtn {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 22px;
        font-size: 22px;
        text-align: center;
        border: none;
        border-radius: 0;
        color: white;
        background: #888;
        opacity: 0.85;
        pointer-events: none;
        transition: 0.25s;
        display: none;
    }

    #finishBtn.active {
        background: #28a745;
        opacity: 1;
        pointer-events: auto;
    }
.order-count {
    margin: 15px 0 5px 0;
    padding: 14px 18px;
    background: #ffe4ef; /* roz foarte deschis */
    border-left: 6px solid #d81b60; /* accent brand */
    border-radius: 8px;

    color: #d81b60;
    font-size: 22px;
    font-weight: 800;
    letter-spacing: 0.5px;

    text-align: center;
}

</style>
</head>

<body>

<h1>Nailly â€“ Pick & Pack</h1>

<!-- ================= PAS 1 ================= -->
<h3>Pas 1: SelecteazÄƒ comanda</h3>

<!-- ðŸ”¥ AfiÈ™Äƒm numÄƒrul comenzilor -->
<h4 id="orderCount" class="order-count"></h4>

<!-- CÄƒutare comenzi -->
<input id="orderSearch" placeholder="CautÄƒ comanda dupÄƒ numÄƒrâ€¦" oninput="filterOrders()" />

<!-- ListÄƒ comenzi -->
<select id="orderList" size="8">
    <option>Se Ã®ncarcÄƒ comenzile...</option>
</select>

<button onclick="loadOrder()">ÃŽncarcÄƒ comanda</button>

<h3 id="orderTitle"></h3>


<!-- ================= PAS 2 ================= -->
<h3>Pas 2: ScaneazÄƒ produsele</h3>

<input id="scanInput" placeholder="ScaneazÄƒ EAN / SKU..." onkeypress="handleScan(event)" disabled />

<button onclick="startCameraScan()">ScaneazÄƒ cu camera telefonului</button>

<div id="cameraScanner" style="width:100%; margin-top:10px; display:none;"></div>

<table id="productsTable">
    <thead>
        <tr>
            <th>SKU</th>
            <th>Produs</th>
            <th>Raft</th>
            <th>Cantitate</th>
            <th>Scanat</th>
            <th>RÄƒmas</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button id="finishBtn" onclick="finalizeOrder()">FinalizeazÄƒ comanda</button>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>

// ===================== CONFIG ======================
const ORDER_LIST_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/orders-list";

const ORDER_GET_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/order-get";

const DELETE_ORDER_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/functions/v1/delete-order-file-orderId-";

const PRODUCT_LOCATION_URL =
  "https://yvmqfsigxecmrygmbolg.supabase.co/rest/v1/product_locations?sku=eq.";

let currentProducts = [];
let currentOrderId = null;
let fullOrderList = [];   // pentru filtrare


// ===================== LOAD ORDERS ======================
async function loadOrders() {
    try {
        const res = await fetch(ORDER_LIST_URL);
        const orders = await res.json();
        fullOrderList = orders;

        const select = document.getElementById("orderList");
        select.innerHTML = "";

        orders.forEach((o, index) => {
            const opt = document.createElement("option");
            opt.value = o.orderId;
            opt.textContent = `${index + 1}. Comanda #${o.orderId}`;
            select.appendChild(opt);
        });

        // ðŸ”¥ Actualizare numÄƒr comenzi
        document.getElementById("orderCount").textContent =
            `Mai ai de pregÄƒtit ${orders.length} comenzi`;

    } catch (err) {
        alert("Eroare la Ã®ncÄƒrcarea comenzilor!");
        console.error(err);
    }
}


// ===================== FILTRARE COMENZI ======================
function filterOrders() {
    const term = document.getElementById("orderSearch").value.trim();
    const select = document.getElementById("orderList");

    select.innerHTML = "";

    const filtered = fullOrderList.filter(o =>
        o.orderId.toString().includes(term)
    );

    filtered.forEach((o, i) => {
        const opt = document.createElement("option");
        opt.value = o.orderId;
        opt.textContent = `${i + 1}. Comanda #${o.orderId}`;
        select.appendChild(opt);
    });

    if (filtered.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "Nicio comandÄƒ gÄƒsitÄƒ";
        select.appendChild(opt);
    }
}


// ===================== LOAD ORDER ======================
async function loadOrder() {
    const orderId = document.getElementById("orderList").value;
    if (!orderId) return;

    currentOrderId = orderId;

    const res = await fetch(`${ORDER_GET_URL}?orderId=${orderId}`);
    const data = await res.json();

    currentProducts = await Promise.all(
        data.line_items
            .filter(p => p.item_type === "product")
            .map(async p => {
                let originalSku = p.product_sku;
                let lookupSku = originalSku.replace(/^0+/, "");

                let locRes = await fetch(PRODUCT_LOCATION_URL + lookupSku, {
                    method: "GET",
                    headers: {
                        "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bXFmc2lneGVjbXJ5Z21ib2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNDQ0MzgsImV4cCI6MjA3NTYyMDQzOH0.b9MXrgxADVZGvdFaKFQggD-vMd0ayZ9hX4_PmYOzrfE",
                        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bXFmc2lneGVjbXJ5Z21ib2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwNDQ0MzgsImV4cCI6MjA3NTYyMDQzOH0.b9MXrgxADVZGvdFaKFQggD-vMd0ayZ9hX4_PmYOzrfE"
                    }
                });

                let locData = await locRes.json();

                let shelf =
                    locData.length > 0 &&
                    locData[0].location &&
                    locData[0].location !== "EMPTY"
                        ? locData[0].location
                        : "FÄƒrÄƒ locaÈ›ie";

                return {
                    sku: originalSku,
                    ean: p.product_ean,
                    name: p.product_name,
                    qty: Number(p.quantity),
                    shelf,
                    scanned: 0
                };
            })
    );

    document.getElementById("orderTitle").textContent = "Comanda #" + orderId;
    document.getElementById("scanInput").disabled = false;

    const btn = document.getElementById("finishBtn");
    btn.style.display = "block";
    btn.classList.remove("active");

    renderTable();
}


// ===================== TABLE ======================
function renderTable() {
    const tbody = document.querySelector("#productsTable tbody");
    tbody.innerHTML = "";

    currentProducts.forEach(p => {
        const tr = document.createElement("tr");
        if (p.scanned === p.qty) tr.classList.add("ok");

        tr.innerHTML = `
            <td>${p.sku}</td>
            <td>${p.name}</td>
            <td>${p.shelf}</td>
            <td>${p.qty}</td>
            <td>${p.scanned}</td>
            <td>${p.qty - p.scanned}</td>
        `;
        tbody.appendChild(tr);
    });

    updateFinishButtonState();
}


// ===================== UPDATE FINISH BUTTON ======================
function updateFinishButtonState() {
    const allScanned = currentProducts.every(p => p.scanned >= p.qty);
    const btn = document.getElementById("finishBtn");

    if (allScanned) {
        btn.classList.add("active");
    } else {
        btn.classList.remove("active");
    }
}


// ===================== SCAN ======================
function handleScan(event) {
    if (event.key !== "Enter") return;

    const code = event.target.value.trim();
    event.target.value = "";

    function normalize(val) {
    return val ? val.replace(/^0+/, "") : val;
}

let found = currentProducts.find(
    p => normalize(p.sku) === normalize(code) ||
         normalize(p.ean) === normalize(code)
);

    if (!found) return flashError();

    if (found.scanned < found.qty) {
        found.scanned++;
        renderTable();
    } else {
        flashError();
    }
}

function flashError() {
    let input = document.getElementById("scanInput");
    input.classList.add("errorInput");
    setTimeout(() => input.classList.remove("errorInput"), 300);
}


// ===================== CAMERA ======================
function startCameraScan() {
    const div = document.getElementById("cameraScanner");
    div.style.display = "block";

    const html5QrCode = new Html5Qrcode("cameraScanner");

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 150 } },
        (decodedText) => {
            document.getElementById("scanInput").value = decodedText;
            handleScan({ key: "Enter", target: { value: decodedText } });

            html5QrCode.stop().then(() => {
                div.style.display = "none";
            });
        }
    );
}


// ===================== FINALIZE ORDER ======================
async function finalizeOrder() {
    const btn = document.getElementById("finishBtn");

    if (!btn.classList.contains("active"))
        return alert("Trebuie sÄƒ scanezi toate produsele!");

    if (!confirm("Finalizezi comanda?")) return;

    try {
        const res = await fetch(DELETE_ORDER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: currentOrderId }),
        });

        const result = await res.json();

        if (res.ok && result.deleted?.length > 0) {
            alert("Comanda a fost finalizatÄƒ!");
        } else {
            alert("Eroare la È™tergerea fiÈ™ierului!");
        }

        location.reload();

    } catch (err) {
        console.error(err);
        alert("Eroare la server!");
    }
}


// ===================== INIT ======================
loadOrders();

</script>
</body>
</html>
